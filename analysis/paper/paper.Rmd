---
title: "Bayesian exponential random graph modeling of KWL Burial network"
author:
  - Author One
  - Author Two
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)
```

# Introduction

<!--burial study- network analysis-->
Burials provide valuable information about social structures that can reflect not only the personal life and status of the deceased, but also the expressions of their descendants through grave goods [@Pearson1999]. This enables the study of social differences based on burials to answer questions related to social inequality and complexity [@Ehrhardt2009; @Gamble2002; @Janes2013; @Johansen2015]. Mortuary practices such as burial forms, grave goods, and related ritual practices could represent the social relations between individuals and allow us to infer social structures, for examples, grave goods usually relate to social practices of trade, exchange, and gifting [@Coward2013, pp. 252]. One way to study the relationships between individual is social network analysis (SNA), which can visualize, quantify, and statistically test hypotheses about the relationships to understand network structure and its effects on every part within the network [@Freeman2004; @Salvini2010]. A social network contains a set of actors and a set of relationships connecting these actors, which could be groups, organizations or persons. Their relationships are flows of resources that reflect relations of control, dependence, and cooperation. In other words, actors are viewed as "nodes" in a wider network, in which nodes are connected by multiple relationships, or "edges", to other nodes [@Coward2013; @Mizoguchi2013; @Potgieter2008]. 

<!--archaeology case-->
The archaeological sites in northeastern Taiwan show some evidence of accumulation of imported prestige goods in burials around the same time as European contact in the 17th century[@Chen2007], which might indicate the pursuit of prestige or wealth in the society. In addition to prestige, European colonial powers could have provided military support to indigenous allies. For example, @Voss2005's study of a colonial outpost in California shows that colonial residents have different identities and higher social status than other local indigenous people. A general model to summarize these case studies might be that the support of a colonial power combined with high local values for imported goods, might lead to competition among individuals. In this study, we will use this model of competition to explain the changes in social inequality at Kiwulan, an Iron Age site in northesatern Taiwan, which covers the presence of the Europeans, including the Spanish and the Dutch, in the 17th century and the Chinese in the 19th century. 

<!--current approaches to network analysis-->
Exponential Random Graph Models (ERGMs) are an important family of statistical model for expressing properties of network structures with a focus directly on possible ties between nodes by viewing them as random variables [@Robins2007]. In traditional statistical model for network, each predictor variable for forming a tie between two nodes is measure separately by the presence of a tie without considering interactions among ties [@Morris2008]. By contrast, statistical models assumes social networks as dependent variables that can represent the network dependencies between tie variables [@Snijders2011]. In a network generated by ERGMs, the formation of a tie is influenced by the presence or absence of other ties or attributes of nodes/ties. Predictor variables, called network statistics, such as reciprocity, transitivity, homophily, are direct functions of the ties themselves where the probability of occurrence of the configuration of ties can be specified and hypothesized [@Morris2008; @Robins2007]. The advantage of networks specification under assumptions and contexts can be useful to explain archaeological network in a given time. For example, @Amati2019 demonstrate the use of ERGMs to reconstruct networks consist of a set of sites in the Caribbean during the period AD 100–400. They found the structure of network can be efficiently explained by multiple interdependent mechanisms instead of hypotheses of distance and cultural homophily exclusively. However, they also point out some limitations of application such as static outcome and sensitivity to missing data. Another limitation is that ERGMs are difficult to compute because their normalizing constant depending on model parameters is intractable. With the development of Markov chain Monte Carlo (MCMC) algorithms that produce approximate maximum likelihood estimators and graph statistics for further specification of transitivity and heterogeneity, ERGMs can deal with complicated dependence patterns observed at one moment in time [@Snijders2006]. A Bayesian framework allows for parameter inference using Markov chain Monte Carlo (MCMC) strategies which avoid the need for computationally intensive calculations of the normalizing constants [@Caimo2011]. 

## Bayesian modeling 

<!--Bayesian inference for Exponential Random Graph Models--> 
Bayesian approach to ERGMs is an efficient computational tool for social network analysis because it incorporates prior information about the network effects into the model and offers uncertainty quantification by evaluating the posterior distribution of the parameters associated with the network effects [@Caimo2015; @Nemmers2019]. This provides better estimations for complex social network models with heterogeneous data [@Caimo2017]. For archaeological data, missing data could be a problem leading to misinterpretation, which can be also reduced by using Bayesian modelling that provides average 80% correct prediction for the ties and allow 25% false with a third of data missing [@Koskinen2010].
- weighted data

Using the R software, we use Bayesian SNA to study burials from Kiwulan, an Iron Age site in northeast Taiwan. We view individual burials as actors or nodes in the social network with ties drawn between burials when the presence of the same variables that can represent the same "community" or social group. We test hypotheses about the distribution of influence in the network to identify network or corporate mode conditions. We ask the questions: 1. Do the observed burial data indicate a more clustered network than a distribution of random networks with similar qualities? 2. Whether European colonial activities in 17 century Taiwan resulted in the emergence of social inequality in an indigenous society can be detected by burials networks. 3. How the relations among burials may affect the quantity of burial goods? We expect the network to present a higher degree of clustering (e.g. the number of completed triangles in the network) in the European contact period that might hint at social heterogeneity during this period. This study helps to expand the use of burials in understanding the indirect effects of a colonial presence on indigenous groups. A Bayesian approach enables the efficient quantification for uncertainty, parametrization, and model evaluation of social network metrics.

# Archaeological background

```{r read-data}
library(readxl)
library(tidyverse)
library(here)

# read data
burial <- read_excel(here("analysis", "data", "raw_data", "Kiwulan_Burials.xlsx"))
```

```{r tidy-data}
# combine some periods
burial_three_period_age_tidy <-
  burial %>%
  rename(burial_label = ID) %>%
  mutate(Phase = ifelse(Phase == 'euro', 'post', Phase)) %>%
  filter(!is.na(Phase)) %>%
  mutate(Gold_leaf = ifelse(Gold_leaf == "shatter", "1", Gold_leaf),
         Stoneware = ifelse(Stoneware == "base", "1", Stoneware),
         Stamped_ceramic = ifelse(Stamped_ceramic == "cluster", "1", Stamped_ceramic)) %>%
  mutate_at(21:ncol(.), as.numeric) %>%
  janitor::remove_empty(which = "cols") %>%
  mutate(total = rowSums(.[c(21:48, 50, 55, 56)], na.rm = TRUE)) %>% #prestige goods
  mutate(Porcelain = rowSums(.[c(40:48, 55, 56)], na.rm = TRUE)) %>% #B&W, porcelain, Anping, kendi
  mutate(Porcelain = ifelse(Porcelain == 0, NA, Porcelain)) %>%
  mutate(quantity = case_when(
    total == 0 ~ "none",
    total > 0 & total <= 7 ~ "low",
    total > 7 & total < 100 ~ "medium",
    total >= 100 ~ "high",
    TRUE ~ "")) %>% # the classification is based on the result of histogram
  mutate(Age_scale = case_when(
    `Age` %in% c("1","2") ~ "0-12",
    `Age` == "3" ~ "12~20",
    `Age` %in% c("4","5","6","7","8") ~ "+20",
    TRUE ~ "NA")) %>%
  mutate(gender = case_when(
    `Gender` %in% c("1","2") ~ "male",
    `Gender` %in% c("3","4") ~ "female",
    TRUE ~ "NA")) %>%
  mutate(ritual = case_when(
    `Stamped_ceramic` == "2" ~ "two pots",
    `Stamped_ceramic` == "1" ~ "one pot",
    TRUE ~ "NA")) %>%
  mutate(Gold_bead_low = ifelse(Golden_bead == 1, 1, NA),
         Gold_bead_med = ifelse(Golden_bead > 1 & Golden_bead <10, 1, NA),
         Gold_bead_high = ifelse(Golden_bead > 10, 1, NA),
         Agate_bead_low = ifelse(Agate_bead == 1, 1, NA),
         Agate_bead_med = ifelse(Agate_bead > 1 & Agate_bead <10, 1, NA),
         Agate_bead_high = ifelse(Agate_bead > 10, 1, NA),
         `Indo-Pacific_bead_low` = ifelse(`Indo-Pacific_bead` < 100, 1, NA),
         `Indo-Pacific_bead_med` = ifelse(`Indo-Pacific_bead` > 100 & `Indo-Pacific_bead` < 900, 1, NA),
         `Indo-Pacific_bead_high` = ifelse(`Indo-Pacific_bead` > 900, 1, NA)) %>% #based on the result of histogram
  select(burial_label,
         Phase,
         Age_scale,
         gender,
         ritual, # consider to remove if not very informative
         Gold_bead_low,
         Gold_bead_med,
         Gold_bead_high,
         Agate_bead_low,
         Agate_bead_med,
         Agate_bead_high,
         Porcelain, #prestige good
         Gold_leaf, #prestige good
         fish_shape_knit, #prestige good
         quantity)

# number of each phase
burial_three_period_age_number <-
  burial_three_period_age_tidy %>%
  count(Phase)

pre_E <- burial_three_period_age_number$Phase[4]
post_E <- burial_three_period_age_number$Phase[3]
```

```{r prep-network-object-pre}
# filter pre burials
burial_pre <-
  burial_three_period_age_tidy %>%
  filter(Phase == "pre") %>%
  janitor::remove_empty(which = "cols") 

# create node list using burial index by phase
#--------------------pre--------------------------------
nodes_pre <-
  burial_three_period_age_tidy %>%
  filter(Phase == "pre") %>%
  select(burial_label) %>%
  rowid_to_column("id")

# pair wise combinations for burials as index for later map function
library(gtools)
burial_comb_pre = combinations(length(nodes_pre$burial_label), #t(combn(nodes_pre$burial_label, 2))
                               2, nodes_pre$burial_label,
                               repeats = TRUE)
colnames(burial_comb_pre) = c("burial_1", "burial_2")
burial_comb_pre = as_tibble(burial_comb_pre)

# create list for each burial that contains the burial good types and their counts
edge_list_pre <-
  burial_three_period_age_tidy %>%
  select(burial_label, 6:14) %>% # need to change for each exploration
  pivot_longer(-burial_label, names_to = "goods", values_to = "count") %>%
  #mutate(burial_connection = rep(unique(burial_label), length.out = length(burial_label)))
  group_by(burial_label) %>%
  nest()

# pair-wise list
common_counts_lst_pre <-
  map2(burial_comb_pre$burial_1,
       burial_comb_pre$burial_2,
       ~bind_cols(
         edge_list_pre %>%
           filter(burial_label == .x) %>%
           unnest(data),
         edge_list_pre %>%
           filter(burial_label == .y) %>%
           unnest(data)) %>%
         rowwise() %>%
         mutate(common_counts = sum(count...3, count...6)))

# count of ornament types in common between each pair of burials
common_counts_vct_pre <- map_int(common_counts_lst_pre, ~sum(!is.na(.x$common_counts)))

burial_comb_with_common_counts_pre <-
  burial_comb_pre %>%
  mutate(common_counts = common_counts_vct_pre) %>%
  mutate(common_counts = ifelse(burial_1 == burial_2, 0, common_counts)) # use 0 for self loop

# change label to ids for node linking
edges_pre <-
  burial_comb_with_common_counts_pre %>%
  left_join(nodes_pre, by = c("burial_1" = "burial_label")) %>%
  rename(from = id) %>%
  left_join(nodes_pre, by = c("burial_2" = "burial_label")) %>%
  rename(to = id)

edges_for_network_pre <-
  select(edges_pre, from, to, common_counts) %>%
  filter (!common_counts == 0) # remove rows with no goods in common
# %>% mutate(common_counts = ifelse(common_counts > 1, 1, common_counts)) # for unweighted network
```

```{r prep-network-object-post}
# filter post burials
burial_post <-
  burial_three_period_age_tidy %>%
  filter(Phase == "post") %>%
  janitor::remove_empty(which = "cols") %>%
  filter(quantity != "none") # remove burial without burial goods

# create node list
nodes_post <-
  burial_three_period_age_tidy %>%
  filter(Phase == "post") %>%
  filter(quantity != "none") %>%
  select(burial_label) %>%
  rowid_to_column("id")

# pair wise combinations for burials as index for later map function
library(gtools)
burial_comb_post = combinations(length(nodes_post$burial_label),
                               2, nodes_post$burial_label,
                               repeats = TRUE)
colnames(burial_comb_post) = c("burial_1", "burial_2")
burial_comb_post = as_tibble(burial_comb_post)

# create list for each burial that contains the burial good types and their counts
edge_list_post <-
  burial_three_period_age_tidy %>%
  select(burial_label, 6:14) %>% # need to change for each exploration
  pivot_longer(-burial_label, names_to = "goods", values_to = "count") %>%
  group_by(burial_label) %>%
  nest()

# pair-wise list
common_counts_lst_post <-
  map2(burial_comb_post$burial_1,
       burial_comb_post$burial_2,
       ~bind_cols(
         edge_list_post %>%
           filter(burial_label == .x) %>%
           unnest(data),
         edge_list_post %>%
           filter(burial_label == .y) %>%
           unnest(data)) %>%
         rowwise() %>%
         mutate(common_counts = sum(count...3, count...6)))

# count of ornament types in common between each pair of burials
common_counts_vct_post <- map_int(common_counts_lst_post, ~sum(!is.na(.x$common_counts)))

burial_comb_with_common_counts_post <-
  burial_comb_post %>%
  mutate(common_counts = common_counts_vct_post) %>%
  mutate(common_counts = ifelse(burial_1 == burial_2, 0, common_counts)) # use 0 for self loop

# change label to ids for node linking
edges_post <-
  burial_comb_with_common_counts_post %>%
  left_join(nodes_post, by = c("burial_1" = "burial_label")) %>%
  rename(from = id) %>%
  left_join(nodes_post, by = c("burial_2" = "burial_label")) %>%
  rename(to = id)

edges_for_network_post <-
  select(edges_post, from, to, common_counts) %>%
  filter (!common_counts == 0) # remove rows with no goods in common
```

<!--archaeological setting-->
We analyzed burial data collected from the upper component of Kiwulan site, an Iron Age settlement site (1350-1850 AD) located in northeastern Taiwan, which experienced the European colonial impacts in the early 17th century and the large wave of Chinese immigrants in the 19th century [@Chen2007]. The excavation revealed abundant pottery sherds, imported ceramics and stonewares, wooden artifacts, stone tools, metal artifacts, imported glass beads and agates beads, and pipes [@Chen2007]. In addition to these artifacts, 90 burials, hundreds of middens, storage pits, and postholes with in-situ posts were also excavated. The burials are mostly located in the middle section of the excavation area, which is the largest open area at Kiwulan that provides continuous stratigraphic sections suitable for temporal comparison. Those burials are oriented in an east-west direction on the north side of the house structures indicated by postholes and `in-situ` wooden posts, indicating a well organized space arrangement. 

Previous studies on burials suggest a presence of uneven distribution of prestige goods across burials. However, there is a debate over whether the differentiation between burials hints an economic inequality supporting an egalitarian society [@Hsieh2012], or political inequality indicating a stratified society [@Cheng2008]. @Cheng2008 interprets the unequal distribution of prestige materials, especially the gold-foil beads between burials, as evidence for hierarchy. However, @Hsieh2012 suggests a relatively egalitarian society based on the comparative analysis of frequency and proportion of all burial goods. She found that the burials with rich goods were usually associated with elders, which might indicate achieved, rather than inherited, status. The earliest record of the use of prestige goods in burials can be traced back around the European arrival according to historical records from the Spanish and the Chinese [@Borao2009; @LiandWu2006]. For example, the Spanish document by a Spanish Priest described that the Spanish soldier used agate beads to exchange materials from local indigenous people since they were valuable in their culture [@LiandWu2006]. In addition, there was a custom that people would bury imported materials with deceased to display their status and influence [@LiandWu2006]. Despite we observed the economic differentiation in burial goods and the high value of imported goods according to historical documents, the degree of inequality over time, and which variable decides the changes remain unclear. Analyzing and comparing burial data from different phases using network analysis approaches will give an insight into the degree and changes in social inequality. This is important to understand the social reactions of Kiwulan residents in the context of the foreign contact. 

<!--chronology-->
We assigned burials to the pre-European period (n = `r pre_E`), European and post-European period (n = `r post_E`) for network comparison according to depth, radiocarbon dates, diagnostic materials, stratigraphic data, and previous studies. Since the sedimentary characteristics show vertical and lateral continuity cross units of AD section, depth is used as the first criterion for burial chronology. The chronology is then evaluated by the burials with time marker, light gray glazed jars, also called An-ping jars. The jars were believed to be produced in Southeast China and circulated in Southeast Asia from the late 16th to 18th century, but are often found at sites with the European occupation in the early 17th century in Taiwan [@Berrocal2018; @Hsieh1995; @Ketel2011]. In addition to the diagnostic jars, three radiocarbon dates of charcoal associated with three different burials are used as another evidence to evaluate the chronology [@Chen2007]. Some burials that were heavily disturbed by modern construction are excluded to avoid misinterpreting due to incomplete data. With the information of burials, including quantity of grave goods, types of grave goods, burial identities, we can reconstruct social relations between individuals by linking them according to similar prestige goods. This is based on the assumption that the prestige goods imply social practices of trade, exchange, and gifting that reflect social relations between individuals [@Coward2013, pp. 252]. Also, prestige materials usually relate to a representation of social status, where the same economic or social class, tend to use similar goods as a status indicators [citations]. Therefore, we build network where burials represent actors (nodes in the network) that are linked when they have th same prestige goods in common. The prestige goods we identified including agate beads, gold-foil beads, imported Chinese porcelains, gold foils, and fish-shaped ornaments, according to previous research [@Cheng2008; @Hsieh2009; @Hsieh2012; @Wang2011] and the description in historical records [@Borao2009; @LiandWu2006]. 

# Methods

## data and hypoethesis

We analyzed archaeological burials from an Iron Age site, Kiwulan, in northeastern Taiwan based on data collected from published excavation report, and original fieldwork notes to generate networks. We do not include the burials in Chinese phase in our network analysis because of the small sample size. A network is a structure can be represented as a graph consisting of a set of nodes (actors) and edges (ties) connecting them [@Brughmans2018; @Robins2007]. In our case, burials are nodes linked by edges if any pair of burial has the prestige goods in common. Due to gold-foil beads and agate beads commonly found across burials with substantial differences in counts, we assigned those prestige goods into three levels based on the distribution of their counts to indicate quantity, high, medium, and low. That means if burial 1 and burial 2 both have high quantity of agate beads, then there will be a tie connecting them. For prestige goods not commonly found across burials, including imported porcelains, gold foils, and fish-shaped ornaments, we assign a tie between burials when they possess the good in common. Node attributes here include osteological data and mortuary practices, such as age, gender, burial ritual, and wealth level. Burial ritual is identified by locally made ceramics on the top of grave that suggests the presence of funeral feasting. Wealth level is an important attribute for economical inequality that we assigned the burials into three classes, high, medium, and low, as an index of wealth, based on the quantity of burial goods. Since burials tend to have multiple prestige goods in common, the network ties are weighted instead of binary data (where the value 1 represents a tie and the value 0 otherwise) [@Snijders2011]. For example, if two burials have both low quantity of glass beads and porcelain in common, the tie is given a value of 2. Our networks are non-directed, which means ties have no orientation forming the relationship between actors. 

Our hypothesis is that after the start of the European presence in the 17th century, a group of ambitious individuals competed with each other for access to trade with the Europeans due to the high value of trade goods in their society. The high value of trade goods had been identified by the historical documents written by the Europeans and the Han Chinese [@Borao2009; @LiandWu2006]. In addition to valuable foreign goods, the indirect colonialism in northeastern Taiwan may suggest the potentially manipulation of the European colonial image by local ambitious individuals for building their personal status and power. This led to the monopolization of valuable goods among a small numbers of individuals and the society gradually switched to a structure with more social inequality. If the social inequality gradually increased in Kiwulan, then we will observe it from the burials by analyzing the networks generated by those social processes. Network analysis provides a way to understand the underlying mechanisms that shape the relationships between people at Kiwulan, and the effect of foreign contact on these relationships. Our purpose is to identify changes in network structure of burials before and after the foreign contacts, and explore which variables may have contributed to the observed economic inequality across burials using network analysis approaches. This is important to understand how an Indigenous society reacted to the presence of foreign imperial power. 

## Model specification 
<!--Network construction-->

We use Bayesian inference on exponential random graph models (ERGMs) to quantify the relationships among burials and test our hypothesis. ERGMs are statistical models for building complex social networks where possible ties are assumed as random variables and dependent on actor variables or the presence or absence of other ties [@Robins2007]. In ERGMs, ties form a small structure in a network called a graph configuration that describes the form of dependence, such as reciprocity (relationship between two actors), transitivity (relationship between two actors through a shared third actor), homophily (relationship between actors with a similar attribute), or popularity (actors have many relationships with others) [@Robins2007; @Snijders2006; @Morris2008]. Those configurations represent the structure or the property of a network and can be expressed by network statistics. By specifying the forms of configurations, we can build a hypothesis-based model to generate a distribution of random networks. Such distribution consists of a large number of possible networks that provides a statistical inference for an observed network [@Robins2007]. This helps to understand whether an observed network shows significantly more or less property of interest than the random networks we modeled. 

Table \@ref(tab:ergm-terms-table) lists the configurations we used for the model specification for burials with archaeological interpretations. Every parameter in an ERGM has an associated algorithm for computing its value for a network [@Morris2008]. We test our hypothesis by measuring reciprocity, transitivity, popularity, and homophily structure effects. We expect that if our hypothesis is a good match with the data then we should see less reciprocally, less transitivity, but higher popularity structure effects after the European presence. This structure infers the presence of a few individuals as centers having more relations with others with a decrease in small and multiple groups, which hints the emergence of social inequality. We also consider homophily effects based on node attributes, including age, gender, ritual, and the degree of wealth, to explore the correlation between the tendency of connected nodes and the network ties overall. This can imply the major effect that contributes to the network that we observed and give an insight into the underlying mechanism of social inequality if any. 

```{r ergm-terms-table}
ergm_terms <- readxl::read_excel(here("analysis", "data", "raw_data", "ergm_term.xlsx")) 
kableExtra::kable(ergm_terms,
             caption = "The parameters of exponential random graph models for a undirected network to corresponding with archaeological evidence.")
```

<!--Bayesian approaches-->

We analyzed social networks using the R programming language with bergm package for Bayesian exponential random graph models [@Caimo2014]. Bergm provides a framework for Bayesian parameter estimation on the result of exponential random graph models, which depends on ergm packages for simulation and model specification [@Hunter2008; @Morris2008; @Handcock2008]. Although exponential random graph models can better describe a network by capturing the dependency structure, it is difficult to estimate model parameters and interpret the result due to the intractable normalizing constant and model degeneracy [@Caimo2014; @Jin2013]. A normalizing constant is a step to make probability distribution to integrate to one, which becomes hard to compute for larger set of networks [@Caimo2017bayesian]. Another problem is the degeneracy that means the probability models tend to overestimate a small number of extreme graphs by assigning too much weight, such as empty (all nodes unconnected) or complete graphs (all nodes connected) [@Schweinberger2011; @Caimo2014]. To overcome these limitations, Bayesian model applies Markov chain Monte Carlo (MCMC) simulation with the exchange algorithm, which solves computational problems in ERGMs [@Caimo2011]. 

<!--Model fitting and comparison--> 

Markov chain Monte Carlo (MCMC) is an estimation of posterior distribution of interest through directly random sampling the posterior without assuming the prior is a normal distribution. We can obtain a distribution by constructing a Markov chain that describes a sequence of moves from current state to the next state following probabilistic rules based on algorithms. This enables a random or stochastic simulation in a long run without depending on the previous move. More chains ensures a more desirable distribution close to the target distribution that we study, which is called the convergence of the Markov chains. In Bayesian ERGMs, MCMC first selects a set of edges (or a set of empty pair of actors) with equal probability, and than switch to a pair of actors at random within the chosen set [@Caimo2011]. In our case, we set the number of chains to six. For each chain, the number of burn-in iterations is 200 and the number of iterations after the burn-in is 2000. We set the number of iterations used to simulate a network y′ at each iteration to 10,000. The models are assessed by goodness-of-fit (GOF) diagnostics in the Bayesian framework, where the observed network is compared with the set of networks simulated from the estimated posterior distribution of the parameters of the model [@Caimo2011; @Caimo2017]. This provides a statistical approach to check how well the estimated posterior parameter distribution can reproduce networks similar to the general structural features of the observed network. Our observed networks, pre-European and post-European networks, followed the normal distribution that is a suitable prior model in network analysis that assumes networks with low density and high transitivity commonly observed in real world [@Caimo2017]. Since our original data implies higher transitivity due to potentially multiple groups having the same kind of burial good in common, we specified the prior based on our observation with high transitivity and low density. 

<!-- Goodness-of-fit assessment-->

# Results

```{r network-ggraph}
# network analysis using ggraph pkg
library(tidygraph)
library(ggraph)
# pre-Euro
relation_tidy_pre <- tbl_graph(nodes = nodes_pre,
                               edges = edges_for_network_pre,
                               directed = FALSE)

relation_tidy_pre %>%
  activate(edges) %>%
  arrange(desc(common_counts))

# plot
ggraph(relation_tidy_pre, layout = "graphopt") +
  geom_node_point() +
  geom_edge_link(aes(width = common_counts), alpha = 0.8) +
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = burial_label), repel = TRUE) +
  labs(edge_width = "common item") +
  theme_graph()

# post-Euro
relation_tidy_post <- tbl_graph(nodes = nodes_post,
                               edges = edges_for_network_post,
                               directed = FALSE)

relation_tidy_post %>%
  activate(edges) %>%
  arrange(desc(common_counts))

# plot
ggraph(relation_tidy_post, layout = "graphopt") +
  geom_node_point() +
  geom_edge_link(aes(width = common_counts), alpha = 0.8) +
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = burial_label), repel = TRUE) +
  labs(edge_width = "common item") +
  theme_graph()
```

```{r network-object}
library(network)

burial_network_pre <-
  network(edges_for_network_pre, # the network object
          vertex.attr = nodes_pre, # node list
          directed = FALSE, # specify whether the network is directed
          ignore.eval = FALSE, # FALSE = weighted
          loops = FALSE, # do we allow self ties (should not allow them)
          matrix.type = "edgelist") # the type of input

burial_network_post <-
  network(edges_for_network_post,
          vertex.attr = nodes_post,
          directed = FALSE,
          ignore.eval = FALSE, 
          loops = FALSE, 
          matrix.type = "edgelist") 
```

The pre-European network shows three subgroups that possessing the same types of burial goods: medium amount of carnelian bead on the right, medium amount of gold-foil beads on the left, and porcelains in the middle. Although burials with different amount of burial goods can be identified, there is no clear clusters demonstrating the sharing of prestige goods only for burials with rich goods. 

```{r add-node-attribute-color}
# prepare notwork objects for Bayesian ERGMs 
library(statnet)
library(Bergm)

# Add attributes to the network object burial_network_pre
set.vertex.attribute(burial_network_pre, "quantity", burial_pre$quantity)
set.vertex.attribute(burial_network_pre, "age", burial_pre$Age_scale)
set.vertex.attribute(burial_network_pre, "gender", burial_pre$gender)

# plot
set.seed(30)
quantity <- get.vertex.attribute(burial_network_pre, "quantity")
age <- get.vertex.attribute(burial_network_pre, "age")

plot(burial_network_pre,
     displaylabels = TRUE,
     vertex.col = "quantity",
     vertex.cex = degree(burial_network_pre, cmode = 'indegree')/5, #size nodes
     pad = 1) 

legend("topleft",
       col = c(2, 3, 1, 4), # need to adjust each time
       pch    = 20,
       legend = unique(quantity), # age
       title  = 'Burial good counts')

#? can't get the items in legend in order, tried as.factor and set their level but does not work
#? can't match color with categories, using an odd method at the moment

# Add attributes to the network object burial_network_post
set.vertex.attribute(burial_network_post, "quantity", burial_post$quantity)
set.vertex.attribute(burial_network_post, "age", burial_post$Age_scale)
set.vertex.attribute(burial_network_post, "gender", burial_post$gender)

# plot
set.seed(30)
quantity <- get.vertex.attribute(burial_network_post, "quantity")
age <- get.vertex.attribute(burial_network_post, "age")
ID <- get.vertex.attribute(burial_network_post, "burial_label") # not sure how to get id on the network plot

plot(burial_network_post,
     displaylabels = TRUE,
     vertex.col = "quantity",
     vertex.cex = degree(burial_network_post, cmode = 'indegree') / 13, #size nodes to their in-degree
     #vertex.sides = ifelse(burial_network_pre %v% "", 4, 50),
     pad = 1)

legend("topleft",
       col = c(4, 3, 2, 1), # need to adjust each time
       pch    = 20,
       legend = unique(quantity),
       title  = 'Burial good counts')
```

## ERGM parameter estimation
<!--interpretation of network plots across phases--> 

```{r network-ERGMs}
# model 1
model.ergm <- burial_network_pre ~
  edges + 
  density +
  triangle 
summary(model.ergm)

# model 2 considers cluster and degree
model.2 <- burial_network_pre ~ 
  edges + # density
  gwesp(0.2, fixed = TRUE) +  # transitivity(cohesion; triangle)
  gwdegree(0.8, fixed = TRUE)  # popularity(degree; star), the frequency distribution for nodal degrees
summary(model.2)

# model 3 with node attributes
model.3 <- burial_network_pre ~ edges +  # the overall density of the network
  nodematch('quantity') + # quantity-based homophily
  nodematch('age') +
  nodematch('gender') +
  gwesp(0.75, fixed = TRUE) +    # transitivity
  gwnsp(0.75, fixed = TRUE) +
  gwdegree(0.2, fixed = TRUE) # popularity
summary(model.3)
```

<!--interpretation of Bayesian modeling--> 


```{r Bayesian-ERGMs}
# Specify a prior distribution: normal distribution (low density and high transitivity)
# need to observe the graph and select suitable prior 
prior.mean <- c(2, 0, 0, 0, 5, 0, 0) 
# follow Alberto Caimo et al. (2015) hospital example
prior.sigma <- diag(3, 7) # covariance matrix structure
# where the dimension d corresponds to the number of parameters, 𝜇 is mean vector and Σprior is a d × d covariance matrix.

# Estimated posterior means, medians and 95% credible intervals for Models.3
# bergmM: Bayesian exponential random graphs models under missing data using the approximate exchange algorithm. Use this because of missing data for age variable
parpost <- bergmM(model.3,
                  prior.mean  = prior.mean,
                  prior.sigma = prior.sigma,
                  burn.in     = 200, # burn-in iterations for every chain of the population, drops the first 200
                  main.iters  = 2000, # iterations for every chain of the population
                  aux.iters   = 10000, # MCMC steps used for network simulation
                  nchains     = 8, # number of chains of the population MCMC
                  gamma       = 0.2) # scalar; parallel adaptive direction sampling move factor, acceptance rate

# summary of parameter estimation
summary(parpost)

# plot the parameter posterior distribution
plot(parpost)
```

## Structure Effects

The network statistics presents each θ that corresponds to the parameter specified in ERGM previously. In general, positive mean indicates positive correlation, while negative mean indicates negative correlation. 

θ1 = number of ties
θ2 = individuals with the same abundance of burial goods
θ3 = gwesp, a positive sign suggests a tendency of burials in our sample to group together in closed transitive structures. In mortuary context, clustering implies a tendency of burials with the same status indicated by prestige goods to be organised in closed structures. Burials with multiple prestige goods in common are more likely to be directed connected.
θ4 = gwdegree, negative estimates reflect an increased likelihood on ties to higher-degree nodes, or the strong edges are not necessarily centralised or dispersed in the degree distribution.

The plots from left to right show estimated marginal posterior densities, trace plots, and auto correlation plots.


```{r Bayesian-gof}
# Model assessment, Bayesian goodness of fit diagnostics:
bgof(parpost,
     aux.iters = 10000,
     n.deg     = 15,
     n.dist    = 15,
     n.esp     = 15)

# An estimated ERGM is fitting perfectly a certain observed network if the red line falls inside this interval
# a result that is very difficult to obtain in practice (Caimo 2017)
```

Figure shows the Bayesian goodness of fit diagnostics plots where the red lines represent the distributions of the observed data and the box plots represent the GOF distributions of 10000 network graphs simulated from ERGMs based on the estimated posterior distribution. The grey lines mark the 95% intervals. X-axis means the proportion of nodes

# Discussion

<!-- briefly discuss Chinese burials -->
Age and gender attributes serve as indicators for distinguishing ascribed or achieved status in a society [citation]. 


# Conclusion

# Acknowledgments

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
