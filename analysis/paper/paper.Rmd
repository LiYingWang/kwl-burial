---
title: "A Bayesian approach to burial networks to infer social changes in northeastern Taiwan during the European colonization period"
author:
  - Li-Ying Wang
  - Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Burials provide valuable information to study social structures based on the assumption that burials and associated grave goods can represent social roles and relations in a society. To study social relationships, network analysis has been increasingly applied to archaeological data to explore network structures and patterns that can infer interactions and relationship between entities. Different from traditional static networks, statistical approaches to network analysis, such as exponential random graph models (ERGMs), provides a way to test hypotheses on dynamic process of network formation. However, the computational difficulty and sensitivity to uncertainties limits the application of ERGMs. In this paper, we introduce a Bayesian framework on ERGMs that enables an efficient computational process, effective quantification for uncertainty, and robust model evaluation of network properties. We tested the hypothesis of social changes relative to the arrival of Europeans by studying burial data from Kiwulan, an Iron Age site in northeastern Taiwan. The results indicate a transition from ties based on ritual objects to wealth objects, and a more centralized structure with social differentiation after European presence in the 17th century. Our case study demonstrates the effectiveness of Bayesian network analysis for archaeological data, and expands the use of burials in understanding the impacts of colonial presence on Indigenous groups in a pericolonial context.
keywords: |
  Bayesian modeling; network analysis; Monte-carlo simulation; Burials; European colonialism; social differentiation; Taiwan
highlights: |
  1. We present Bayesian inference on exponential random graph models (ERGMs) to model archaeological networks.
  2. We explore social processes and network structures in archaeological data from from two time periods.
  3. Differences in network statistics imply change over time in social structures influenced by foreign presence. 
  4. Bayesian ERGMs are efficient and useful for evaluating and interpreting networks. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  dpi = 300,
  fig.path = "../figures/"
)

image_width_1_col_inch = 90/25.4 # image Single column	w = 90 mm 
image_width_2_col_inch = 190/25.4 # image Double column w = 190 mm 
image_width_3_col_inch = 190/19
```

# Introduction {-}

<!--burial study- network analysis-->
Burial analysis by archaeologists is an approach to understand past social structures through the study of the physical traces of mortuary practices. The material cultures and biological records of burial behaviors can represent the social ranking or identities of the deceased [@Binford1971; @Drennan2010; @Saxe1970]. Despite criticism that manipulation of burial rituals by the living can cause a disconnect between a person's status in life and their status represented by burial contexts [@Hodder1980; @Pearson1982], burials can still provide valuable information to infer past societies [@Chapman2003]. By studying burial forms, grave goods, and ritual behaviors that structure the material configuration of burials, we can infer social status and relations between members of a community that give an insight to social structures [@Byrd1995; @Seikel2011]. Based on network science and graph theory, the recent development of social network analysis provides many new tools to visualize and analyze relationships in archaeological data [@Borgatti2009; @Brughmans2013]. Network science is the study of relational data where a phenomenon is conceptualized as a network through two steps, abstraction and representation [@Brandes2013; @Collar2015]. A network can be viewed as a patterned aggregation that includes individual elements (i.e. individual burials), pair-wise relationships (the dyads, for example burials with similar types and amounts of grave goods), and an overall structure showing global patterns represented in the data. Burials with the same prestige goods could indicate some underlying social relations where individuals share similar access to trade, exchange, and gifting networks according to their status [eg. @Coward2013, pp. 252]. This paper will use a novel Bayesian approach on exponential random graph model for networks to investigate the formation of relationship between burials in northeastern Taiwan to explore the indirect impact of foreign presence on social organization.

<!-- intro to networks: move to SI -->

<!-- two types of network analysis: move to SI -->

## A Case Study from Northeastern Taiwan  {-}

<!-- archaeological background -->
Archaeological sites in northeastern Taiwan show evidence of accumulation patterns of imported goods, such as ornaments and porcelains, in residential areas and the use as burial goods around the same time as European contacts in the 17th century [@Chen2007; @LWandBM2020ornament]. Imported goods were treated as prestige or wealth in those Indigenous societies that were commonly mentioned in Spanish historical records [@Borao2009; @LiandWu2006]. For example, the document written by a Spanish Priest described that the Spanish soldier used carnelian beads to exchange natural resources with local Indigenous people since their high values in Indigenous culture [@LiandWu2006]. In addition, an Indigenous person possessing more imported goods may have been recognized as more influential or having higher status by their community [@LiandWu2006]. Despite we observed the uneven distribution of imported goods in burials, the degree of differentiation across burials over time remain unclear. The use of imported items as prestige goods in local Indigenous communities might occur earlier before a European presence became established, but was maintained and amplified after European arrival due to local competition for power [@Borao2009; @LiandWu2006; @LWandBM2020ornament; @Ueda2016]. A general model to summarize this situation in northeastern Taiwan might be that the influence of a colonial power, combined with high local values of imported goods, might lead to increased social inequality due to competition among individuals [@Brumfiel1994; @Clark1994]. The observed uneven distribution in Northeastern Taiwan may be explained as a result of unequal access to trade networks when Indigenous societies were involved in the complex trade network stimulated by the Europeans. 

<!-- archaeological specific case study -->
In this study, we explore social changes in a pericolonial context at Kiwulan (Figure \@ref(fig:figure-KWL-map)), an Iron Age site in northeastern Taiwan, which covers the time before the European arrival, the presence of the Europeans, including the Spanish and the Dutch, in the 17th century, and finally the Chinese in the 19th century [@Chen2007]. We assume that social changes at Kiwulan would be supported by chronological differences in the structure of burial networks. We examine burial networks before and after the foreign contacts, and test our hypothesis that increased social inequality can be observed in the network after the European arrival. We ask: (1) did European colonial activities in 17th century Taiwan result in an increased social inequality in an Indigenous society in ways that can be detected by analysis of burial networks? (2) what are the major variables affecting or forming the higher degree of popularity (e.g. a few nodes have more relationships with other nodes) in the European contact period that might hint at social heterogeneity during this period? By answering these questions, this study helps to expand the use of statistical modeling for burials in understanding the indirect effects of a colonial presence on Indigenous groups. This is important to understand reactions to indirect impacts of European colonization. 

```{r figure-KWL-map, fig.cap = "The location of Kiwulan and the European forts at Heping dao and Tamsui in northern Taiwan (modified from Wang and Marwick, 2020). Map data from naturalearthdata.com."}

knitr::include_graphics(here::here("analysis", "figures", "000-KWL-map.png"))
```

# Exponential random graph models in a Baysesian framework  {-}

<!-- ERGM in archaeology, and limitations --> 
Exponential random graph models first appeared in archaeology with @Brughmans2014, who studied Iron age settlement patterns in Southern Spain by modeling inter-settlement visibility networks and visual control at 159 sites. Although their models do not fit perfectly with the observed network of archaeological data, they proposed that ERGM is a promising method for exploration and hypothesis testing for social processes. Similarly, @Amati2019 modeled three networks consisting of 15 sites (AD 100 to 400) in the Caribbean to explore interaction mechanisms, including proximity, inter-cultural items, and pottery types. By comparing hypothesized networks with the observed sites, they found that the presence of hub sites can be efficiently explained by multiple interdependent mechanisms instead of only one variable exclusively. However, those studies also point out some limitations of ERGM, such as sensitivity to missing data and less ability to handle uncertainty. In addition, it is difficult in ERGM to estimate model parameters and interpret the result due to intractable likelihood normalizing constants and model degeneracy [@Caimo2014; @Jin2013]. A normalizing constant is a function of the model parameter for making probability distributions integrate to one, which becomes harder to compute with larger set of networks [@Caimo2017bayesian]. This is also termed "doubly intractable" since both the likelihood normalizing constant and the marginal likelihood (the evidence of the posterior) are hard to derive [@Caimo2013; @Lyne2015]. Model degeneracy is another issue that probability models tend to overestimate a small number of extreme graphs by assigning too much weight, such as empty (all nodes unconnected) or complete graphs (all nodes connected) [@Schweinberger2011; @Caimo2014]. One solution to these limitations is available by implementing ERGMs in a Bayesian framework. 

<!-- current approaches to network analysis: move to SI -->

<!-- Bayesian inference for Exponential Random Graph Models --> 
Bayesian approaches to Exponential Random Graph Models (ERGMs) are effective tools for network modeling by incorporating prior information about the network configurations to better understand dependencies of network variables and improve computational issues in ERGMs [@Caimo2017; @Lehmann2020]. The advantage that Bayesian modeling has over traditional ERGMs is the application of Markov chain Monte Carlo (MCMC) simulation using the approximate exchange algorithm [@Caimo2011]. MCMC avoids doubly-intractable computations by directly sampling from the not normalized part of the posterior, which alleviates the computational problems and gives a better convergence results. This enable us to deal with complicated dependence patterns with ease, providing better estimations for complex social network models with heterogeneous data [@Caimo2017; @Snijders2006]. After fitting an ERMG with an MCMC algorithm, a Bayesian approach generates posterior probabilities that incorporates our sample data and prior information derived from previous data or our assumptions through summary statistics from estimates of the ERGM parameters [@Caimo2015; @Nemmers2019]. This also allows uncertainty quantification. Posterior probability estimates the effect of ERGM parameters by looking at the posterior mean and 95% credible intervals, which can replace p-values for assessing a null hypothesis [@Caimo2017bayesian]. The typical criteria for interpreting the posteriors is that an odds ratio greater than one means a positive effect of a parameter, while odds ratios less than one represents negative effect. In addition, Bayesian approaches are also useful to deal with missing data, which is often a problem leading to misinterpretation of networks, especially for archaeological studies. @Koskinen2010 shows that the effect of missing data can be reduced with Bayesian modeling that can predict, on the average, 80% of the ties when a third of data missing. 

# Materials  {-}

```{r import-and-inspect-data, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/000-prep-data.R"))}
suppressWarnings(source(here::here("analysis", "paper", "000-prep-data.R")))
```

```{r tidy-data, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/001-data-tidy.R"))}
suppressWarnings(source(here::here("analysis", "paper", "001-data-tidy.R")))
```

<!-- archaeological setting -->
We analyzed burial data collected from the published excavation reports, and the original fieldwork notes for the upper component of Kiwulan, an Iron Age settlement (1350-1850 AD) [@Chen2007]. Excavations revealed abundant trade goods, including imported ceramics and stonewares, metal artifacts, glass beads, and stone beads, indicative of frequent trade activities [@Chen2007]. A total of 90 burials were unearthed that are mostly located in the middle section of the excavation area, which is the largest open area at Kiwulan that provides continuous stratigraphic sections suitable for temporal comparison (Figure \@ref(fig:figure-burial-map)). Burials are oriented in an east-west direction on the north side of the residential area, indicated by post-holes and _in-situ_ wooden posts, suggesting a well organized spatial arrangement. Previous studies report an uneven distribution of prestige goods across burials without agreement about whether this uneven distribution hints at vertical social differences. For example, @Cheng2008 interpreted the unequal distribution of glass beads, especially the gold-foil beads between burials, as evidence for hierarchy, indicating a stratified society. However, @Hsieh2012 suggested a relatively egalitarian structure based on comparative analysis of the frequencies of all burial goods. She found that the burials with high value goods were usually associated with elders, which might indicate achieved, rather than inherited, status. One important limitation of these previous studies is that they did not use analytical units suitable for comparing pre-European social organization with post-European social organization. Here, we adopt a new chronological framework for the burials to test if network configurations differ from the pre-European period to the post-European period. The discord over the discussion of Kiwulan social organization could be associated with chronological differences that has not yet been well studied. 

```{r burial-location, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/002-burial-location.R"))}
suppressWarnings(source(here::here("analysis", "paper", "002-burial-location.R")))
```

```{r figure-burial-map, fig.cap = "Map illustrating the location of burials by periods at the central excavation area of Kiwulan (each square is 4 X 4 meters). The gray dots are post holes."}
knitr::include_graphics(here::here("analysis", "figures", "002-burial-map.png"))
```

```{r sample-size}
# number of each phase
library(tidyverse)
pre_E <- burial_three_period_age_number %>% filter(Phase == "pre") %>% pull()
post_E <- burial_three_period_age_number %>% filter(Phase == "post") %>% pull()
chi <- burial_three_period_age_number %>% filter(Phase == "chi") %>% pull()
disturb <- burial_three_period_age_number %>% filter(Phase == "disturbed") %>% pull()
diff_pre_post <- post_E - pre_E
```

<!-- chronology -->
To compare burial networks, we assigned burials to the pre-European period (n = `r pre_E`), European and post-European period (n = `r post_E`). Our assignments are based on an established fine-grained chronology that was reexamined and cross-validated by diagnostic materials, stratigraphic data, depth, and radiocarbon ages [@LWandBM2020ornament; @Chen2007]. We excluded burials from the Chinese phase (n = `r chi`) due to the smaller sample size. There are `r disturb` burials heavily disturbed by modern construction that are also excluded because we cannot determine their chronology. Based on the assumption that social status and associated relations can be represented by sharing similar prestige goods [cf. @Coward2013, pp. 252], we built networks where burials (nodes in the network) that are linked when they have the same prestige goods in common. The prestige goods we identified include gold-foil beads, carnelian beads, glass beads, Chinese porcelains, stonewares, gold foils, and fish-shaped ornaments. Previous studies indicate that these items are considered as high-value across different archaeological contexts [@Cheng2008; @Hsieh2009; @Hsieh2012; @Wang2011]. Historical accounts written by Europeans and the Han Chinese also support these items as prestige goods [@Borao2009; @LiandWu2006].

# Methods {-}

```{r bergm-pre, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/003-burials-pre-network-modelling.R"))}
suppressWarnings(source(here::here("analysis", "paper", "003-burials-pre-network-modelling.R")))
```

```{r bergm-post, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/004-burials-post-network-modelling.R"))}
suppressWarnings(source(here::here("analysis", "paper", "004-burials-post-network-modelling.R")))
```

## Hypothesis and construction of networks {-}

<!-- our hypothesis --> 
Our pericolonial impact hypothesis is that rare, high quality burial goods accumulated in only a few individuals' burials after the European presence because of increased social inequality at Kiwulan due to differential access to these goods. A related effect of the European presence in northeastern Taiwan may have been manipulation of the European colonial image by ambitious local Indigenous individuals for building their personal status and power, recognized as network strategies to achieve power [@Drennan2010; @Feinman2000]. If social inequality gradually increased in Kiwulan as we hypothesize, then we expect to observe a network with higher degree (popularity) and less transitivity (cohesion), along with greater differences in wealth accumulation according to burial goods. To test this hypothesis, we use Bayesian ERGMs to model the formation of network ties and the underlying mechanisms that shape relationships between people at Kiwulan. By comparing networks from the pre-European period and the post-European period we can examine the effects of foreign contact on community relationships at Kiwulan.

```{r network-diagrams, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/005-network-diagrams-two-phases.R"))}
suppressWarnings(source(here::here("analysis", "paper", "005-network-diagrams-two-phases.R")))
```

```{r burial-value}
ave_value <- round(mean_burial_value,1) 
high_value <- round(high_burial_value,1) 
```

<!-- burial data and the definition of tie formation  --> 
We used burial goods in common to construct ties for representing a flow of good between burials. Since trade beads are commonly found across burials with substantial differences in quantities, we described each burial as having one of four levels, high, upper-middle, lower-middle, and low, according to their distributions across all burials (details in Supplementary Online Materials). For less frequent prestige goods, including imported ceramics, gold foils, and fish-shaped ornaments, we linked two burials when they possess each type of goods (i.e. presence or absence). Node attributes here include osteological data, such as age and sex, and cultural data, such as ritual pottery, and burial value index. Ritual pottery was identified as locally made ceramics placed above graves that suggests funeral feasting based on historical records. The burial value index is an important attribute for economical inequality that we assigned the burials into three levels, high (>`r high_value`, top 10 percent), above average (`r ave_value`-`r high_value`), and below average (<`r ave_value`), as an index of wealth. The number is the sum of values of each type of prestige good, which is calculate by the total number of a prestige item from burial context over the number of prestige item in a burial. Since burials tend to have multiple prestige goods in common, the network ties are weighted instead of binary data (the value 1 represents a tie and the value 0 otherwise) [@Snijders2011]. For example, if two burials have both low quantity of glass beads and porcelain in common, the tie is given a value of 2. Our networks are non-directed, which means ties have no orientation forming the relationship between actors to indicate a mutual relationship. The networks constructed based on this principles show that the network after the European presence has higher node degrees in general (Figure \@ref(fig:figure-network-diagrams)). 

```{r figure-network-diagrams, fig.cap = "A: Burial network before the European arrival, B: Burial network after the European arrival. The size of the nodes is proportional to the node degrees that means the number of connections to a node. The thickness of tie represents the number of goods in common between nodes."}
knitr::include_graphics(here::here("analysis", "figures", "005-network-diagrams.png"))
```

## Model specification in a Bayesian framework {-}

<!-- Network construction and specification -->
We quantify the relations among burials and test our hypothesis of social change using the R programming language [@Rlanguage2019] with the bergm package [@Caimo2014], which is built upon the statnet package for model specification and simulation procedures [@Hunter2008; @Morris2008; @Handcock2008]. Table \@ref(tab:table-ergm-terms) lists the network parameters we used for the model specification with the corresponding archaeological evidence. Every parameter in an ERGM has an associated algorithm for computing the probability of observing relations in terms of grave goods between two burials. Based on our hypothesis, we model a network with increased social inequality that is represented by endogenous network effects: low transitivity and high popularity. We include burial-specific attributes as covariate effects for homophily, such as age, sex, ritual activity, and the degree of wealth, to explore and test the tendency of tie forming. For example, age-homophily means people of the same age tend to have the same burial goods. We also include the physical distance between burials as an indicator of a kinship-based relation since the deceased from the same family tend to be buried nearby [@LiandWu2006]. Our model could reveal the emergence of social inequality via the presence of a few individuals as network centers, having more relations with others. This would be indicated by high popularity or degree values in the network statistics, with covariates to control the preferential tendency of formation of relationship. According to our hypothesis, the burial evidence from after the European arrival will show higher popularity compared with the burial evidence from before European contact. 

```{r table-ergm-terms}
ergm_terms <- readxl::read_excel(here::here("analysis", "data", "raw_data", "ergm_term.xlsx")) 
knitr::kable(ergm_terms,
             caption = "Network parameters in ERGMs used for model specifications with assocaited interpeation for burial relations.")
```

```{r bergm-prior-and-iteration}
prior_mean <- as_tibble(cbind(pre_prior_mean, 
                              post_prior_mean)) %>% 
  mutate(mean_same = ifelse(pre_prior_mean == post_prior_mean, pre_prior_mean, NA))

prior_sigma <- as_tibble(cbind(diag(pre_prior_sigma), 
                               diag(post_prior_sigma))) %>% 
  rename(pre_prior_sigma = V1, post_prior_sigma = V2) %>% 
  mutate(sigma_same = ifelse(pre_prior_sigma == post_prior_sigma, pre_prior_sigma, NA))

priors <- cbind(prior_mean, prior_sigma)
bgof_si <-10000
```

<!-- add text about prior setting and anthropological assumptions of our prior values --> 
Normal distributions for the priors are typical in network analysis studies that assume networks to have low density and high transitivity, as are commonly found in the real world [@Caimo2017]. Thus, we specified the prior of the edge density parameter to low for both network models. For covariates about biological features, such as age, sex, we specified a vague prior that follows a normal distribution with mean at `r priors$mean_same[2]` and standard deviations at `r priors$sigma_same[2]`for both models to explore their effects. For physical distance between burials, we also set a vague prior effect (N(`r priors$mean_same[8]`, `r priors$sigma_same[8]`)) to explore whether there is kinship-based proximity, e.g. stronger correlations for shorter distances. To evaluate our anthropological assumption about increased social inequality over time, we incorporated different prior information for the network variables that are meaningful for social inequality, especially for transitivity (gwesp) and popularity (gwedegree). We set the priors to higher transitivity (N(`r priors$pre_prior_mean[6]`, `r priors$pre_prior_sigma[6]`)), lower popularity (N(`r priors$pre_prior_mean[7]`, `r priors$pre_prior_sigma[7]`)), and higher covariate effect based on ritual activity (N(`r priors$pre_prior_mean[4]`, `r priors$pre_prior_sigma[4]`)) for network before European contact to indicate less social inequality and stress ritual element shared in corporate groups. On the contrary, we set the priors for the network after the European arrival to lower transitivity (N(`r priors$post_prior_mean[6]`, `r priors$post_prior_sigma[6]`)), higher popularity (N(`r priors$post_prior_mean[7]`, `r priors$post_prior_sigma[7]`)), and higher covariate effect of burial values (N(`r priors$post_prior_mean[5]`, `r priors$post_prior_sigma[5]`)) to model an increased social inequality. This prior information derives from theory about horizontal hierarchies, which can be viewed as a spectrum that illustrates an increasing social inequality from a corporate mode at one end toward a network mode at the other end [@Drennan2010; @Feinman2000]. The priors for density were also set the same with N(`r priors$mean_same[1]`, `r priors$sigma_same[1]`) for both pre- and post-European networks based on a common observation of network density. 

<!-- assessment of MCMC and Goodness-of-fit in Bayesian: move to SI -->

# Reproducibility and open source materials {-} 

The entire R code [@Rlanguage2019] used for all the analysis and visualizations contained in this paper is included in the Supplementary Online Materials at https://doi.org/xxx/xxx to enable re-use of materials and improve reproducibility and transparency [@Marwick2017]. Also in this version-controlled compendium [@Marwick2018] are the raw data for all the visualizations and tests reported here. All of the figures, tables, and statistical test results presented here can be independently reproduced with the code and data in this repository. The code is released under the MIT license, the data as CC-0, and figures as CC-BY, to enable maximum re-use. 

# Results {-}

```{r posterior-distribution, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/006-bergm-distribution-stats.R"))}
suppressWarnings(source(here::here("analysis", "paper", "006-bergm-distribution-stats.R")))
```

<!--posterior stats for pre-E-->
We examine the estimates from the posterior distributions to compare their differences in structure of the simulated networks (Table \@ref(tab:table-posterior-stats); Figure \@ref(fig:figure-posterior-distribution)). For the pre-European network simulations, the nodal covariates, ritual-homophily, have significant effects on the formation of relations between burials. The positive effect demonstrates that burials with ritual pottery tend to form relations. Despite positive values for some covariates, such as age-homophily, sex-homophily and burial value-homophily, they do not show a significant tendency to form relations duo to value of zero in the confidence intervals. Similarly, the dyadic covariate, physical distance, shows no significant effect, indicating that physical proximity between burials does not affect the formation of relations. For the endogenous network effects, transitivity (gwesp) present significant positive effect, while popularity (gwdegree) demonstrates negative effect. The high positive value for transitivity suggests a tendency of burials to be clustered in closed transitive structures, indicative of the presence of multiple corporate groups sharing burial goods in common. The negative popularity shows there is a tendency toward decentralization that reflects most burials have similar number of ties without any prominent ones. This might imply that individuals have equal access to trade goods in terms of the flow of goods. 

```{r table-posterior-stats}
# tidy data for the table of posterior stats 
posterior_esti_two_phases<-
  bergm_two_phases %>%
  pivot_longer(!phase, 
               names_to = "parameter", 
               values_to = "posterior") %>%
  mutate(parameter = factor(parameter,
                            levels=c("edges", "nodematch.age", 
                                     "nodematch.sex", "nodematch.ritual",
                                     "nodematch.value", "gwesp",	
                                     "gwdeg", "dyadcov.distance"))) %>% 
  group_by(parameter, phase) %>% 
  summarize(mean = round(mean(posterior), 2),
            median = round(quantile(posterior, 0.5), 2),
            `2.5%` = round(quantile(posterior, 0.025), 2),
            `97.5%` = round(quantile(posterior, 0.075), 2)) %>% 
  pivot_wider(names_from = phase, 
              values_from = c(mean, median, `2.5%`, `97.5%`)) %>% 
  select(parameter, ends_with(c("pre", "post")))

library(flextable)
# add column labels
ft <- flextable(posterior_esti_two_phases) %>% 
  set_header_labels(mean_pre = "pre-Euorpean", median_pre = "pre-Euorpean", 
                    `2.5%_pre` = "pre-Euorpean", `97.5%_pre` = "pre-Euorpean",
                    mean_post = "post-Euorpean", median_post = "post-Euorpean", 
                    `2.5%_post` = "post-Euorpean", `97.5%_post` = "post-Euorpean") %>%
  merge_at(i = 1, j = 2:5, part = "header") %>% 
  merge_at(i = 1, j = 6:9, part = "header") %>% 
  add_header_row(values = c("", "mean", "median", "2.5%", "97.5%",
                            "mean", "median", "2.5%", "97.5%"), top = FALSE ) %>% 
  align(j = 2:9, align = "right", part = "header") %>% 
  align(i = 1, align = "center", part = "header") %>% 
  width(j = ~ parameter, width = 1.3) %>% 
  width(j = 2:9, width = 0.65) %>% 
  set_caption("Estimated posterior means, medians, and 95% credible intervals for each network parameter of two models.")
ft
```

```{r figure-posterior-distribution, fig.cap = "Posterior density estimates for the parameters associated with edges, gwesp, gwdegree, and distance-dyadcov by phases. The pre-European group presents remarkedly larger values for the gwesp, but lower vlaues for the edges and gwdegree parameters comapred to the post-Eruoepan group. The distance parameters overlap between two groups."}
knitr::include_graphics(here::here("analysis", "figures", "006-posterior-distribution.png"))
```

<!--posterior stats for for post-E and their comparison-->
For the network after the arrival of Europeans, the nodal covariates of burial value-homophily show positive effects, while the ritual-homophily and sex-homophily have a negative effect. Despite the effect is not strong, it could indicate the burials in the same wealth level tend to form relations. On the contrary, the same sex burials and burial with ritual pottery in common tend not to form relations. There are no significant effects for age-homophily and the dyadic covariate, physical distance. Similar to the pre-European network, the endogenous network variable, transitivity (gwesp) demonstrates a significant positive effect but much lower than the effect of pre-European network. In contrast, the popularity (gwdegree) shows a significantly higher positive effect than the effect of pre-European network. This means there is a tendency toward centralization that reflects a limited number of burials have many more ties than others. This implies that a few central individuals may have better access to trade goods and developed personal networks through wealth accumulation. In general, the post-European network has a smaller transitivity effect and a positive popularity effect than the pre-European network. This may suggest a reduced tendency toward clustering but high tendency toward centralization after the European presence. Both posterior estimates present symmetric distributions, with the posterior means close to posterior medians (Table \@ref(tab:table-posterior-stats)). 

```{r bootstrap-CI-test, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/007-bootstrap-CI.R"))}
suppressWarnings(source(here::here("analysis", "paper", "007-bootstrap-CI.R")))
```

<!-- comparison between two networks using bootstrap --> 
One key difference between the pre-European and post-European networks is their size, with `r pre_E` burials compared to `r post_E` burials. To understand the robustness of comparison between two networks, we used vertex bootstrap to cross-validate the results based on Bayesian network analysis. Vertex bootstrap is a non-parametric method that conducts resampling for all vertices (i.e. node) that is useful for quantifying standard errors and estimating sampling variability in the network statistics of interest [@Chen2019; @Snijders1999; @Rroberts2021]. This enables the evaluation of uncertainty for networks and tests the difference between multiple networks by examining their confidence intervals for the network population. Networks with unoverlapped intervals means there is a significant difference. We computed and compared endogenous network statistics, including density, popularity, and transitivity for our two networks. Figure \@ref(fig:figure-bootstrap-CI) shows a significant difference in observed network popularity between the two networks, which is consistent with our finding of negative popularity in the pre-European period and positive popularity in the post-European period using the Bayesian approach. For density and transitivity, the 95% confidence intervals from two networks overlapped with each other that indicates no significant difference. This is also consistent with our results of Bayesian modeling, where both networks present similar positive or negative effects with smaller degree of difference. 

```{r figure-bootstrap-CI, fig.cap = "The 95% bootstrap confidence intervals for the observed networks, the top one with 0 nodes removal, and networks with different number of node removal. The number of bootstrap samples is 1000."}
knitr::include_graphics(here::here("analysis", "figures", "007-bootstrap-CI.png"))
```

```{r bootstrap-t-test, include=FALSE, cache=TRUE, cache.extra=tools::md5sum(here::here("analysis/paper/008-bootstrap-t-test.R"))}
suppressWarnings(source(here::here("analysis", "paper", "008-bootstrap-t-test.R")))
pval_den <- signif(density_b_test$p.value, 4)
pval_trans <- signif(trans_b_test$p.value, 4)
pval_star <- signif(star_b_test$p.value, 4)
```

The vertex bootstrap procedure with a t-test on the difference of network populations also shows that there are significant differences in network density(p = $`r pval_den`$), transitivity (p = $`r pval_trans`$), and popularity (p = $`r pval_star`$). Moreover, we explored the sample size effect by removing nodes at certain percents (5-40%) for both networks and compared their confidence intervals. The results (Figure \@ref(fig:figure-bootstrap-CI)) demonstrate a consistent difference between the two networks within 30 % node removals that suggest they are robust to the different sizes. In general, those statistical methods support the presence of anthropologically meaningful differences in the pre-and post-European networks. The procedure of cross-validation ensures our results can provide robust comparison between two networks without sample size effects. 
 

```{r figure-bgof-two-phases, fig.cap = "Goodness-of-fit diagnostics for the pre-European model (left) and the post-European model (right). Boxplots represent distributions calculated on 100 network graphs simulated from the estimated posterior distribution. Red lines represent distributions of observed networks, and gray lines show the 95% intervals."}
library(magick)
pre_bgof_img <- image_read(here::here("analysis/figures/003-pre-bgof.png"))
post_bgof_img <- image_read(here::here("analysis/figures/004-post-bgof.png"))
image_append(c(pre_bgof_img, post_bgof_img))
```

<!--assessment of MCMC analysis and BGOF--> 
Bayesian goodness of fit (GOF) diagnostics plots (Figure \@ref(fig:figure-bgof-two-phases)) show that both models fit the observed networks very well for the minimum geodesic distance distribution (i.e. the number of edges between node pairs in a shortest path [@Hunter2008]) and the degree distribution. For edgewise shared partner (gwesp) distribution, despite some observations falling outside the 95% interval, the fit is generally good with most observations within it. This also suggests that our models can reproduce networks that resemble the structural features of our observed networks. We compared the first three distribution moments of each observed distribution and their corresponding simulated distributions, represented by means. Figure \@ref(fig:figure-distribution-moments) shows that modeled values from the pre-European network are slightly closer to the observed values for the mean and the variance of distributions, compared to the values from the post-European network. In general, this demonstrates a better fit for the pre-European network. However, it should be noted that the differences between the statistics of two models are relatively small, which still allows direct comparison of two networks.

```{r figure-distribution-moments, fig.cap = "Distribution moments (mean, skewness, and variance) calculated on the observed data and simulated distributions for the pre- and post- European models."}
knitr::include_graphics(here::here("analysis", "figures", "006-distribution-moments.png"))
```

# Discussion {-}

<!-- theoretical framework for the results-->
A striking finding in our results is the change in network properties of Kiwulan burials from a more cohesive network with multiple subgroups (represented by higher transitivity and negative popularity) toward a more centralized network with concentration of connections among fewer burials (lower transitivity and positive popularity) after the European presence during the 17th century. This supports our models of chronological change from a more corporate society to a more networked society, as indicated in the grave goods and burial attributes. These observations are in line with theoretical assumptions of horizontal hierarchy, the corporate-network continuum that focuses on distinct strategies for achieving power as an alternative explanation to understand the emergence and level of social inequality [@Drennan2010; @Feinman2000; @Feinman2000political]. Compared to traditional models of vertical hierarchies that stress stratified social characteristics, the corporate-network model may be more relevant for understanding how a small scale society was organized, such as we see here in the pericolonial context of Kiwulan. A corporate-based society, such as the pre-European situation at Kiwulan, stresses shared power between individuals, communalrituals, and social inequality, if any, would be associated with groups [@Siegel1999]. In contrast, a more network-based society, indicated by the post-European data from Kiwulan, presents wealth accumulation through individual networks, prestige good manipulation, and trade monopolization [@Blanton1996]. It should be noted that the corporate/network continuum represents a dynamic process with different degrees of hierarchical complexity instead of static ideal-type stages.

<!--archaeological implication based on the results-->
The covariants for both networks, before and after the European presence, provide further information to give insights into how specific elements of the archaeological record relate to the formation of networks (Table \@ref(tab:table-posterior-stats)). Our covariants were age, sex, ritual pottery, and a wealth index based on the value of grave goods. The pre-European network shows that burials with pottery as ritual vessels tend to be tied. On the other hand, in the post-European network ties tend to be between burials within the same level of wealth. Moreover, in the post-European network, burials with ritual vessels or same sex tend not to be tied. This illustrates that different social and economic mechanisms determined relations between burials for the two periods. Before European arrival, ritual behaviors seem to have been important status indicators, relative to the use of prestige goods. After European presence was established, status indicators shifted from ritual to wealth differences and sex is not associated with status. Physical distance between burials did not correlate to network formation for either period. This means geographical proximity, implying some kinship association, is not a factor for sharing similar goods between burials. This may suggest that the use of burial goods is more individual-oriented instead of kinship-based. In addition, demographic information, such as age and sex, do not show any correlations with network formation for the pre-European network and only sex shows small effect for the post European network. This may be due to the unavailability of age and sex values for many burials in our sample. 

<!-- other evidence -->
We used burial data as a proxy to explore the relations based on the argument that burials  represent social structures [@Binford1971; @Saxe1970]. We note that there could be an issue of disconnection between the role of the deceased in a burial context and their life, which could be reduced by examining evidence from the residential context [@Chapman2003]. Previous studies of trade ornaments from the residential area of Kiwulan suggests an uneven spatial distribution when the Europeans were active in northern Taiwan that hints at an increased social differentiation at Kiwulan in a pericolonial context [@LWandBM2020ornament]. This is consistent with the result of a more centralized burial network after the presence of Europeans, which supports a connection between a burial and the social role of the living person. Since the burial goods used for making ties were treated as prestige goods or status items in the local Indigenous culture [@Borao2009; @LiandWu2006], the interrelations represented by the flow of goods observed in the burial data likely reflect social contexts of the living people at Kiwulan in a pericolonial context. 

<!--anthopological implication at Kiwulan and limitation-->
At Kiwulan, changes in interburial networks may result from differential access to exotic trade enabled by European contact, gradually leading to increased social differentiation. The image of European power could be embedded into prestige objects pre-existing in local Indigenous culture where their values were amplified with concepts of wealth or power, since their values are contextually mutable and entangled in historical processes [@Aswani2003; @Thomas2009]. This may lead to ambitious individuals to competing with each other for traditional goods and accumulating wealth. It also demonstrates the agency of local Indigenous societies to incorporate and manipulate trade items in a pericolonial context with weak colonial control, gradually resulting in social changes from a more corporate to a more network strategy. We recognise that the meaning of the burial goods remains speculative without rich ethnographic data to support our interpretations. Furthermore, a detailed material culture context for burial goods in residential settings would also help to strengthen our interpretations, but this is not available from Kiwulan. In addition, we acknowledge the fragmentation issue in our archaeological data that limit network interpretations [eg. @Erik2015], such as missing age and sex attributes for some burials at Kiwulan. 

# Conclusion {-}

<!-- summary of the research by answering questions raised in Intro, and anthropological contribution -->
In this paper, we presented a novel approach for studying burial relations using ERGM network analysis within a Bayesian framework. We examined social changes in a European pericolonial context in northeastern Taiwan. We tested the hypotheses of chronological changes in interburial networks at Kiwulan with the evaluation of both endogenous and exogenous network effects. The results support our model that the relationship between burials changed after the European colonization period in the 17th century. Before the arrival of Europeans, the burial network has a tendency of more closed relationships with ritual elements as the key formation mechanism. After European arrival, the network has a tendency of centralization relative to the rarity of goods. The changes in formation mechanisms for networks from ritual-oriented practices to wealth possession suggest increased behavior of wealth accumulation and differentiation stimulated by the European presence and associated long-distance trade network. This aligns with changes in social complexity from a more corporate to a more network mode society with different strategies for achieving power and different degrees of social inequality. Using burial data with historical documents, we are able to detect changes in Indigenous societies indicative of increased social inequality to better understand indirect European colonial impacts that have been underestimated in this region [e.g. @Acabado2017; @Trabert2017]. Furthermore, our study also highlights the agency of local people to manipulate colonial power instead of being passive recipients of trade goods. 

<!-- technical and methodological implication-->
This case study demonstrates the methodological improvement that Bayesian inference on ERGM provides to inform and enhance studies of relational data in archaeology. A Bayesian framework can reduce the effects of small sample size or missing data commonly present in archaeological data by incorporating prior information and MCMC estimations. Bayesian network modeling can be applied to a wide range of archaeological data to examine the formation of relationships using robust probabilistic inference. This enables insights into the dynamic processes of relationship formation and the underlying factors of historical trajectories of socio-cultural phenomena.

<!-- stopped editing here --> 

# Acknowledgments {-}

We would like to thank the Yilan County Cultural Affairs Bureau in Taiwan for permitting access to the data used in this paper. We thank the excavation team of Kiwulan led by Yu-pei Chen for their post-excavation analysis and detailed documents about burials that enables this study. We also thank Alberto Caimo and Steven M. Goodreau for the discussion regarding the methods at the earliest stage fo analysis. This work was supported in part by the travel grant from the Department of Anthropology at University of Washington and the Doctoral Dissertation Fellowship from the Chiang Ching-kuo Foundation for International Scholarly Exchange (Project #DF009-A-18). We thank Ben Fitzhugh and Peter Lape for their insightful comments on an early draft. We also acknowledge comments from anonymous reviewers that have greatly improved this manuscript.

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References {-} 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

Word count: `r wordcountaddin::word_count()`
